name: build

on:
  push:
  pull_request:
  schedule:
    - cron: '0 17 * * 1'
  workflow_dispatch:

jobs:
  setup:
    runs-on: macos-latest
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

  tap:
    runs-on: macos-latest
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Brew tap
        run: brew tap PunGrumpy/formulas

  install_folder:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Brew install from folder
        run: brew install --formula $(pwd)/Formula/*.rb

  install_tap:
    needs: tap
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: List files
        run: ls Formula | sed 's/\.rb//g' > files.txt
      - name: Brew install from tap
        run: |
          while read tap_file; do
            brew install pungrumpy/formulas/$tap_file
          done < files.txt

  audit:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Audit Homebrew Formulas
        run: |
          set -e
          for file in Formula/*.rb; do
            formula=$(basename "$file" .rb)
            echo "Auditing $formula"
            if brew audit pungrumpy/formulas/$formula; then
              echo "$formula audit passed"
            else
              echo "Error: $formula audit failed"
            fi
          done
